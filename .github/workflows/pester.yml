# .github/workflows/pester.yml
name: Pester Tests

on:
  push:
  pull_request:

jobs:
  test:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Pester (if needed)
        shell: pwsh
        run: |
          if (-not (Get-Module -ListAvailable -Name Pester)) {
            Install-Module Pester -Force -Scope CurrentUser -AllowClobber
          }

      - name: Run Pester tests
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          Import-Module ./ZabbixApi.psm1 -Force

          # Find test files explicitly
          $tests = Get-ChildItem -Path ./Tests -Filter *.Tests.ps1 -Recurse -ErrorAction SilentlyContinue

          if (-not $tests -or $tests.Count -eq 0) {
              Write-Host "No test files were found under ./Tests. Listing files for debugging:"
              Get-ChildItem -Path . -Recurse | Where-Object { $_.FullName -like "*Tests*" } | Select-Object -First 200 | Format-Table -AutoSize
              throw "No test files found. Ensure Tests/*.Tests.ps1 exists and was checked out by actions/checkout."
          }

          foreach ($t in $tests) {
              Write-Host "Running tests in $($t.FullName)"
              Invoke-Pester -Script $t.FullName -EnableExit
          }